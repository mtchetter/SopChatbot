<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>HEI Hotels and Resorts - SOP Query System</title>
<style>
    :root{
        --bg:#ffffff;
        --panel:#f3f6fb;
        --panel-2:#e6edf6;
        --ink:#1e293b;
        --muted:#3b82f6;
        --muted-2:#475569;
        --line:#cbd5e1;
        --line-2:#94a3b8;
        --accent:#1da1f2;
        --bubble-user:#dbeafe;
        --bubble-ai:#f1f5f9;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    body{
        font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Oxygen','Ubuntu','Cantarell',sans-serif;
        background:var(--bg); color:var(--ink); line-height:1.6;
    }

    .app-header{text-align:center;padding:32px 16px 20px;border-bottom:1px solid var(--line);}
    .app-title{font-size:2rem;font-weight:700;letter-spacing:-.02em;}
    .app-title .hei-text{color:var(--accent)}
    .app-sub{color:var(--muted);font-weight:600;margin-top:6px}
    .app-desc{color:var(--muted-2);font-size:.9rem;margin-top:4px}

    .shell{display:flex; max-width:1000px; margin:0 auto; padding:16px;}
    .left{flex:1;min-width:0;display:flex;flex-direction:column;}

    .chat-panel{
        flex:1; display:flex; flex-direction:column;
        background:var(--panel); border:1px solid var(--line); border-radius:12px; overflow:hidden;
        min-height:60vh;
    }
    .chat-header{padding:12px 16px;background:var(--panel-2);border-bottom:1px solid var(--line-2);font-weight:700;color:var(--muted)}
    .chat-stream{flex:1;overflow:auto;padding:20px;display:flex;flex-direction:column;gap:14px;font-size:1rem}
    .msg{display:flex;gap:12px;max-width:85%}
    .msg.user{align-self:flex-end}
    .msg.ai{align-self:flex-start}
    .avatar{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;font-size:16px;border:1px solid #cbd5e1;background:#e2e8f0;color:#1e293b}
    .bubble{padding:14px 16px;border-radius:14px;font-size:1rem;line-height:1.7;border:1px solid var(--line-2)}
    .msg.user .bubble{background:var(--bubble-user)}
    .msg.ai .bubble{background:var(--bubble-ai)}
    .name-row{font-size:.75rem;color:var(--muted);margin-bottom:6px;font-weight:700}
    .composer{border-top:1px solid var(--line-2);padding:14px;background:var(--panel);display:flex;gap:10px;align-items:flex-end}
    .prompt{flex:1;min-height:56px;max-height:180px;resize:vertical;padding:14px;background:transparent;border:1px solid var(--line);border-radius:12px;color:#1e293b;outline:none;font-size:1rem}
    .send{background:var(--accent);color:#fff;border:none;padding:14px 20px;font-size:.95rem;font-weight:700;border-radius:12px;cursor:pointer}
    .send:hover{transform:translateY(-1px)}
    .send:disabled{opacity:.6;cursor:not-allowed;transform:none}

    /* Simple "Source: <name>" line inside the chat bubble */
    .source-line{
        margin-top:12px;padding-top:12px;border-top:1px solid var(--line);
        font-size:.93rem;
    }
    .source-line a{font-weight:700;text-decoration:none;color:#0ea5e9}
    .source-line a:hover{text-decoration:underline}

    .toast{
        position:fixed;bottom:16px;left:50%;transform:translateX(-50%);
        background:#111827;color:#fff;border-radius:10px;padding:10px 14px;font-size:.9rem;display:none
    }
</style>
</head>
<body>
<header class="app-header">
    <div class="app-title"><span class="hei-text">HEI</span> HOTELS & RESORTS</div>
    <div class="app-sub">Standard Operating Procedures</div>
    <div class="app-desc">Professional AI-powered SOP document analysis and intelligent query processing</div>
</header>

<main class="shell">
    <!-- Left: Chat only (links panel removed) -->
    <section class="left">
        <div class="chat-panel">
            <div class="chat-header">ðŸ’¬ Conversation</div>
            <div class="chat-stream" id="chatStream"></div>
            <div class="composer">
                <textarea id="prompt" class="prompt" placeholder="Ask anything about our SOPs..."></textarea>
                <button id="send" class="send">Send</button>
            </div>
        </div>
    </section>
</main>

<div id="toast" class="toast" style="display:none;"></div>

<script>
const $ = s=>document.querySelector(s);
const chatStream=$("#chatStream"), promptEl=$("#prompt"), sendBtn=$("#send");

function escapeHTML(s){return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}
function nl2br(s){return s.replace(/\n/g,"<br>")}
function toast(m){
  let t=$("#toast");
  if(!t){t=document.createElement('div');t.id='toast';t.className='toast';document.body.appendChild(t)}
  t.textContent=m;t.style.display="block";setTimeout(()=>t.style.display="none",3000);
}
function addUserMessage(t){
  const el=document.createElement("div");
  el.className="msg user";
  el.innerHTML=`<div class="avatar">ðŸ‘¤</div><div class="bubble"><div class="name-row">You</div><div>${escapeHTML(t).replace(/\n/g,"<br>")}</div></div>`;
  chatStream.appendChild(el);chatStream.scrollTop=chatStream.scrollHeight;
}
function addAssistantMessage(h){
  const el=document.createElement("div");
  el.className="msg ai";
  el.innerHTML=`<div class="avatar">ðŸ¤–</div><div class="bubble"><div class="name-row">Assistant</div><div class="answer-content">${h}</div></div>`;
  chatStream.appendChild(el);chatStream.scrollTop=chatStream.scrollHeight;
}

/** Build a single "Source: <name>" line where <name> is from metadata['source'] and hyperlinked */
function buildSourceLine(docs){
  if(!docs || !docs.length) return "";
  const top = docs[0];

  // Use metadata['source'] as the display text
  let name = (top && typeof top.source === 'string' && top.source.trim())
    ? top.source.trim()
    : "";

  // Fallback: last path segment if source missing (defensive)
  if(!name){
    try {
      const u = new URL(top.doclink);
      const tail = u.pathname.split('/').filter(Boolean).pop() || u.host;
      name = decodeURIComponent(tail);
    } catch(_) {
      name = "Document";
    }
  }

  const link = top.doclink;
  const safeName = escapeHTML(name);

  // If link is missing (shouldn't be), just show plain text
  if(!link) return `<div class="source-line">Source: ${safeName}</div>`;

  return `
    <div class="source-line">
      Source: <a href="${link}" target="_blank" rel="noopener noreferrer">${safeName}</a>
    </div>
  `;
}

async function ask(){
  const q = promptEl.value.trim();
  if(!q){toast("Enter a question");return;}
  addUserMessage(q);
  sendBtn.disabled=true; sendBtn.textContent="â€¦";
  try{
    const r = await fetch("/query",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:q})});
    if(!r.ok) throw new Error("HTTP "+r.status);
    const d = await r.json();
    if(d.error){
      toast(d.error);
      addAssistantMessage(`<span style='color:#f87171'>${escapeHTML(d.error)}</span>`);
    }else{
      const answerHtml = nl2br(d.answer||"");
      const sourceLine = buildSourceLine(d.documents);
      addAssistantMessage(answerHtml + sourceLine);
    }
  }catch(e){
    toast("Network error");
    addAssistantMessage(`<span style='color:#f87171'>${escapeHTML(e.message)}</span>`);
  }finally{
    sendBtn.disabled=false; sendBtn.textContent="Send"; promptEl.value="";
  }
}

document.getElementById("send").onclick=ask;
document.getElementById("prompt").onkeydown=e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();ask();}}
</script>
</body>
</html>
